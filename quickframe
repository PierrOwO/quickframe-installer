#!/usr/bin/env php
<?php
// QuickFrame CLI

if ($argc < 3 || $argv[1] !== 'new') {
    echo "Usage:\n";
    echo "  quickframe new <project-name>\n";
    exit(1);
}

$projectName = $argv[2];
$targetPath = getcwd() . DIRECTORY_SEPARATOR . $projectName;

if (file_exists($targetPath)) {
    echo "Error: Folder '$projectName' already exists.\n";
    exit(1);
}

$templateRepo = 'https://github.com/PierrOwO/quickframe-template.git';

echo "Cloning QuickFrame template...\n";

$tmpDir = sys_get_temp_dir() . DIRECTORY_SEPARATOR . 'qf_' . uniqid();
exec("git clone " . escapeshellarg($templateRepo) . " " . escapeshellarg($tmpDir) . " 2>&1", $output, $code);

if ($code !== 0) {
    echo "Error: Failed to clone template repository.\n";
    echo implode("\n", $output) . "\n";
    exit(1);
}

function copyFolder(string $src, string $dst): void {
    if (!is_dir($dst)) {
        mkdir($dst, 0755, true);
        chmod($dst, 0755);
    }

    $files = scandir($src);
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') continue;
        $srcPath = $src . DIRECTORY_SEPARATOR . $file;
        $dstPath = $dst . DIRECTORY_SEPARATOR . $file;

        if (is_dir($srcPath)) {
            copyFolder($srcPath, $dstPath);
        } else {
            copy($srcPath, $dstPath);
            chmod($dstPath, 0644);
        }
    }
}

copyFolder($tmpDir, $targetPath);

$gitDir = $targetPath . DIRECTORY_SEPARATOR . '.git';
if (is_dir($gitDir)) {
    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        exec('rmdir /s /q ' . escapeshellarg($gitDir));
    } else {
        exec('rm -rf ' . escapeshellarg($gitDir));
    }
}

chdir($targetPath);
exec('git init');

exec((strtoupper(substr(PHP_OS, 0, 3)) === 'WIN' ? 'rmdir /s /q ' : 'rm -rf ') . escapeshellarg($tmpDir));

$iterator = new RecursiveIteratorIterator(
    new RecursiveDirectoryIterator($targetPath, RecursiveDirectoryIterator::SKIP_DOTS)
);

foreach ($iterator as $file) {
    $filename = $file->getFilename();
    if ($filename === 'quickframe' || pathinfo($filename, PATHINFO_EXTENSION) === 'sh') {
        chmod($file->getPathname(), 0755);
    }
}

echo "Project '$projectName' has been created successfully.\n";
echo "Navigate to the directory: cd $projectName\n";
echo "Start the PHP server: php frame serve\n";
